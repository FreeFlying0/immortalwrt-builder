name: immortalwrt

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: "Enable SSH debug"
        required: false
        default: "false"

env:
  TZ: Asia/Shanghai    
  
jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 1ï¸âƒ£ é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼ˆå¿…è¦ï¼‰
    - name: Free disk space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true        

    # 2ï¸âƒ£ æœ€å°åŒ–ä¾èµ–
    - name: Install Build Dependencies
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-setuptools rsync swig unzip zlib1g-dev file wget \
        llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename \
        libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"

    # 3ï¸âƒ£ å…‹éš† ImmortalWrt
    - name: Clone ImmortalWrt
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git immortalwrt

    # 4ï¸âƒ£ é…ç½® feedsï¼ˆå®˜æ–¹ + kenzoï¼‰
    - name: Configure Feeds
      working-directory: immortalwrt
      run: |
        sed -i '$a src-git smpackage https://github.com/kenzok8/small-package' feeds.conf.default

    - name: Update feeds
      working-directory: immortalwrt
      run: |
        ./scripts/feeds update -a

    # 6ï¸âƒ£ ç²¾ç¡®æ›¿æ¢ golangï¼ˆåªæ›¿æ¢ lang/golangï¼‰
    - name: Defconfig Feeds
      working-directory: immortalwrt
      run: |
        rm -rf feeds/packages/lang/golang
        git clone https://github.com/kenzok8/golang -b 1.25 feeds/packages/lang/golang
        cp -f feeds/smpackage/.github/diy/default-settings package/emortal/default-settings/files/99-default-settings
        rm -rf feeds/packages/net/{alist,adguardhome,brook,gost,mosdns,redsocks*,smartdns,trojan*,v2ray*,xray*}
        rm -rf feeds/packages/luci/{luci-app-homeproxy,luci-app-openclash,luci-app-passwall}
        ./scripts/feeds update -a
        ./scripts/feeds install -a


    # 7ï¸âƒ£ åº”ç”¨ x86 æ—è·¯ç”± nft + Docker é…ç½®
    - name: Apply Config
      working-directory: immortalwrt
      run: |
        cp ../.config .config
        make defconfig

    # 8ï¸âƒ£ ä¸‹è½½æºç 
    - name: Download Packages
      working-directory: immortalwrt
      run: |
        make download -j8

    # 9ï¸âƒ£ ç¼–è¯‘
    - name: Build Firmware
      working-directory: immortalwrt
      run: |
        make -j$(nproc) || make -j1 V=s

    # ğŸ”Ÿ SSH è°ƒè¯•ï¼ˆå¯é€‰ï¼‰
    - name: SSH Debug
      if: github.event.inputs.ssh == 'true'
      uses: mxschmitt/action-tmate@v3

    # 11ï¸âƒ£ ä¸Šä¼ å›ºä»¶
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-x86-firmware
        path: immortalwrt/bin/targets/x86/64/
